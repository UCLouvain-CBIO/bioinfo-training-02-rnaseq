<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 6 Enrichment analyses | RNA-Seq analysis with R and Bioconductor" />
<meta property="og:type" content="book" />




<meta name="author" content="Laurent Gatto and Axelle Loriot" />

<meta name="date" content="2022-10-18" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Chapter 6 Enrichment analyses | RNA-Seq analysis with R and Bioconductor">

<title>Chapter 6 Enrichment analyses | RNA-Seq analysis with R and Bioconductor</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.25/datatables.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">RNA-Seq analysis with R and Bioconductor<p><p class="author">Laurent Gatto and Axelle Loriot</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html">Preamble</a>
<a href="finding-differentially-expressed-features.html"><span class="toc-section-number">1</span> Finding differentially expressed features</a>
<a href="sec-dimred.html"><span class="toc-section-number">2</span> Dimensionality reduction</a>
<a href="summarizedexperiments.html"><span class="toc-section-number">3</span> SummarizedExperiments</a>
<a href="sec-hts.html"><span class="toc-section-number">4</span> High throughput sequencing</a>
<a href="sec-rnaseq.html"><span class="toc-section-number">5</span> Differential expression analysis</a>
<a id="active-page" href="sec-gsea.html"><span class="toc-section-number">6</span> Enrichment analyses</a><ul class="toc-sections">
<li class="toc"><a href="#introduction-1"> Introduction</a></li>
<li class="toc"><a href="#gene-sets"> Gene sets</a></li>
<li class="toc"><a href="#over-representation-analysis-ora"> Over representation analysis (ORA)</a></li>
<li class="toc"><a href="#gene-set-enrichment-analysis-gsea"> Gene set enrichment analysis (GSEA)</a></li>
<li class="toc"><a href="#using-the-clusterprofiler-package"> Using the <code>clusterProfiler</code> package</a></li>
<li class="toc"><a href="#visualisation-of-enrichment-analyses"> Visualisation of enrichment analyses</a></li>
<li class="toc"><a href="#discussion"> Discussion</a></li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body><div id="sec-gsea" class="section level1" number="6">
<h1>
<span class="header-section-number">Chapter 6</span> Enrichment analyses</h1>
<p><strong>Motivation</strong>: at the end of this chapter, the students will be able
to address the following points:</p>
<ul>
<li>What are the next steps after a differential expression analysis?</li>
<li>Why are enrichment analyses useful?</li>
<li>Understanding over representation analyses.</li>
<li>Understanding a gene set enrichment analysis.</li>
<li>Application of the <em><a href="https://bioconductor.org/packages/3.15/clusterProfiler">clusterProfiler</a></em> package.</li>
</ul>
<div id="introduction-1" class="section level2" number="6.1">
<h2>
<span class="header-section-number">6.1</span> Introduction<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('introduction-1')" onmouseout="reset_tooltip('introduction-1-tooltip')"><span class="tooltiptext" id="introduction-1-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<ul>
<li><p>Differential expression analysis is <strong>univariate</strong> - each gene is
tested on its own. This probably doesn’t reflect the underlying
biology - genes work in conjunction, not in isolation. One wouldn’t
expect that the effect of a drug, or a mutation, … would lead to
the perturbation of a single gene expression.</p></li>
<li><p>The univariate approach expects (or tests for) significant changes
in single genes. Moderate effects in many (related) genes cannot, by
definition be identified as statistically significant, even it such
an effect may be biologically more plausible that one of a few large
ones.</p></li>
<li><p>The goal of an enrichment analysis is to test for a group of related
genes, called <strong>gene sets</strong>, and test whether the genes within these
sets are enriched for differentially expression.</p></li>
</ul>
</div>
<div id="gene-sets" class="section level2" number="6.2">
<h2>
<span class="header-section-number">6.2</span> Gene sets<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('gene-sets')" onmouseout="reset_tooltip('gene-sets-tooltip')"><span class="tooltiptext" id="gene-sets-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>While nothing would stop a user to create their own gene sets, the
sets that are generally used stem from community-maintained resources.</p>
<div id="gene-ontology-go" class="section level3" number="6.2.1">
<h3>
<span class="header-section-number">6.2.1</span> Gene Ontology (GO)<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('gene-ontology-go')" onmouseout="reset_tooltip('gene-ontology-go-tooltip')"><span class="tooltiptext" id="gene-ontology-go-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The <a href="http://geneontology.org/">Gene Ontology</a> <span class="citation">(<label for="tufte-mn-9" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-9" class="margin-toggle">Ashburner et al. 2000<span class="marginnote">Ashburner, M, C A Ball, J A Blake, D Botstein, H Butler, J M Cherry, A P Davis, et al. 2000. <span>“Gene Ontology: Tool for the Unification of Biology. The Gene Ontology Consortium.”</span> <em>Nat Genet</em> 25 (1): 25–29. <a href="https://doi.org/10.1038/75556">https://doi.org/10.1038/75556</a>.</span>)</span>
defines GO terms. These terms are based on a controlled vocabulary (to
resuse the same words in a consistent way) and relations<label for="tufte-sn-14" class="margin-toggle sidenote-number">14</label><input type="checkbox" id="tufte-sn-14" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">14</span> Example of relations between terms are, for example, <em>is_a</em>
(mitosis <em>is_a</em> cell cycle phase) or <em>part_of</em> (mitosis <em>part_of</em>
M phase of mitotic cell cycle).</span> that
define the directed links between terms. These relations define a
hierarchy between GO terms: all term can be represented as a (direct
acyclic) graph (DAG). There exist thus very general and very specific
terms.</p>
<p>These terms are classed into three categories, called <em>namespaces</em>:</p>
<ul>
<li>Molecular Function (MF): molecular activities of gene products</li>
<li>Cellular Component (CC): where gene products are active</li>
<li>Biological Process (BP): pathways and larger processes made up of
the activities of multiple gene products</li>
</ul>
<p>Here’s an example of GO term <code>GO:0007155</code>, that describes cell adhesion.</p>
<pre><code>A Term from the GO ontology: GO:0007155
 Label: cell adhesion
  The attachment of a cell, either to another cell or to an underlying
  substrate such as the extracellular matrix, via cell adhesion
  molecules.</code></pre>
<p>If you look at the GO term <code>GO:0007155</code> <a href="http://amigo.geneontology.org/amigo/term/GO:0007155">entry on the Gene Ontology
page</a>, you can
find more details and, if you scroll down, example genes that are
annotated with that term.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-154"></span>
<p class="caption marginnote shownote">
Figure 6.1: Gene ontology entry for the GO term for cell adhesion.
</p>
<img src="figs/go-screenshot.png" alt="Gene ontology entry for the GO term for cell adhesion." width="100%">
</div>
<p>The whole Gene Ontology is can be accessed in R with the
<em><a href="https://bioconductor.org/packages/3.15/GO.db">GO.db</a></em> package.</p>
<p>In the code chunk below, we query the <code>GO.db</code> package through the
<code>org.Hs.eg.db</code> interface. This <em>org.db</em>-type of packages for Homo
sapiens enables to perform various queries for human genes, such as
retrieving all gene symbols and ENTREZ identifiers (the <code>columns</code>
below) that are annotated with a GO term (the <code>keys</code> below) of
interest.</p>
<p>The GO term of interest here is focal adhesion:</p>
<pre><code>A cell-substrate junction that anchors the cell to the extracellular
matrix and that forms a point of termination of actin filaments. In
insects focal adhesion has also been referred to as hemi-adherens
junction (HAJ).</code></pre>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="sec-gsea.html#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"GO.db"</span>)</span>
<span id="cb334-2"><a href="sec-gsea.html#cb334-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"org.Hs.eg.db"</span>)</span>
<span id="cb334-3"><a href="sec-gsea.html#cb334-3" aria-hidden="true" tabindex="-1"></a>GO_0005925 <span class="ot">&lt;-</span> AnnotationDbi<span class="sc">::</span><span class="fu">select</span>(org.Hs.eg.db,</span>
<span id="cb334-4"><a href="sec-gsea.html#cb334-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">keys =</span> <span class="st">"GO:0005925"</span>,</span>
<span id="cb334-5"><a href="sec-gsea.html#cb334-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"ENTREZID"</span>, <span class="st">"SYMBOL"</span>),</span>
<span id="cb334-6"><a href="sec-gsea.html#cb334-6" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">keytype =</span> <span class="st">"GO"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb334-7"><a href="sec-gsea.html#cb334-7" aria-hidden="true" tabindex="-1"></a>    as_tibble <span class="sc">%&gt;%</span></span>
<span id="cb334-8"><a href="sec-gsea.html#cb334-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(ENTREZID))</span></code></pre></div>
<pre><code>## 'select()' returned 1:many mapping between keys and columns</code></pre>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="sec-gsea.html#cb336-1" aria-hidden="true" tabindex="-1"></a>GO_0005925</span></code></pre></div>
<pre><code>## # A tibble: 419 × 5
##    GO         EVIDENCE ONTOLOGY ENTREZID SYMBOL
##    &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt; 
##  1 GO:0005925 HDA      CC       60       ACTB  
##  2 GO:0005925 HDA      CC       70       ACTC1 
##  3 GO:0005925 ISS      CC       71       ACTG1 
##  4 GO:0005925 HDA      CC       81       ACTN4 
##  5 GO:0005925 HDA      CC       87       ACTN1 
##  6 GO:0005925 IMP      CC       88       ACTN2 
##  7 GO:0005925 IMP      CC       89       ACTN3 
##  8 GO:0005925 HDA      CC       102      ADAM10
##  9 GO:0005925 HDA      CC       118      ADD1  
## 10 GO:0005925 HDA      CC       214      ALCAM 
## # … with 409 more rows</code></pre>
<p>We have 419 genes matching this GO term. There are
thus 419 genes in the GO_0005925 GO set.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Repeat the code above to extract the genes annotated with the
<code>GO:0005813</code> term for the centrosome:</p>
<pre><code>A structure comprised of a core structure (in most organisms, a pair
of centrioles) and peripheral material from which a
microtubule-based structure, such as a spindle apparatus, is
organized. Centrosomes occur close to the nucleus during interphase
in many eukaryotic cells, though in animal cells it changes
continually during the cell-division cycle.</code></pre>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-29" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-29', 'sol-start-29')"></span>
</p>
<div id="sol-body-29" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="sec-gsea.html#cb339-1" aria-hidden="true" tabindex="-1"></a>GO_0005813 <span class="ot">&lt;-</span> <span class="fu">select</span>(org.Hs.eg.db,</span>
<span id="cb339-2"><a href="sec-gsea.html#cb339-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">keys =</span> <span class="st">"GO:0005813"</span>,</span>
<span id="cb339-3"><a href="sec-gsea.html#cb339-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">columns =</span> <span class="fu">c</span>(<span class="st">"ENTREZID"</span>, <span class="st">"SYMBOL"</span>),</span>
<span id="cb339-4"><a href="sec-gsea.html#cb339-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">keytype =</span> <span class="st">"GO"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb339-5"><a href="sec-gsea.html#cb339-5" aria-hidden="true" tabindex="-1"></a>    as_tibble <span class="sc">%&gt;%</span></span>
<span id="cb339-6"><a href="sec-gsea.html#cb339-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">duplicated</span>(ENTREZID))</span></code></pre></div>
<pre><code>## 'select()' returned 1:many mapping between keys and columns</code></pre>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="sec-gsea.html#cb341-1" aria-hidden="true" tabindex="-1"></a>GO_0005813</span></code></pre></div>
<pre><code>## # A tibble: 532 × 5
##    GO         EVIDENCE ONTOLOGY ENTREZID SYMBOL
##    &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt; 
##  1 GO:0005813 IDA      CC       35       ACADS 
##  2 GO:0005813 IDA      CC       324      APC   
##  3 GO:0005813 IDA      CC       328      APEX1 
##  4 GO:0005813 IDA      CC       402      ARL2  
##  5 GO:0005813 IDA      CC       403      ARL3  
##  6 GO:0005813 IDA      CC       468      ATF4  
##  7 GO:0005813 ISS      CC       472      ATM   
##  8 GO:0005813 IBA      CC       582      BBS1  
##  9 GO:0005813 IDA      CC       585      BBS4  
## 10 GO:0005813 IDA      CC       598      BCL2L1
## # … with 522 more rows</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="kyoto-encyclopedia-of-genes-and-genomes-kegg" class="section level3" number="6.2.2">
<h3>
<span class="header-section-number">6.2.2</span> Kyoto Encyclopedia of Genes and Genomes (KEGG)<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('kyoto-encyclopedia-of-genes-and-genomes-kegg')" onmouseout="reset_tooltip('kyoto-encyclopedia-of-genes-and-genomes-kegg-tooltip')"><span class="tooltiptext" id="kyoto-encyclopedia-of-genes-and-genomes-kegg-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p><a href="https://www.genome.jp/kegg/pathway.html">KEGG</a> pathway is a
collection of manually drawn and curated pathway maps representing
current knowledge of the molecular interaction, reaction and relation
networks.</p>
<p>The figure below shows the <a href="https://www.genome.jp/kegg-bin/show_pathway?hsa04110">pathways for the cell
cycle</a> in
humans.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-155"></span>
<p class="caption marginnote shownote">
Figure 6.2: KEGG pathway for cell cycle.
</p>
<img src="figs/hsa04110.png" alt="KEGG pathway for cell cycle." width="100%">
</div>
<p>The <em><a href="https://bioconductor.org/packages/3.15/KEGGREST">KEGGREST</a></em> package provides a client interface to the KEGG server.</p>
</div>
<div id="reactome" class="section level3" number="6.2.3">
<h3>
<span class="header-section-number">6.2.3</span> Reactome<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('reactome')" onmouseout="reset_tooltip('reactome-tooltip')"><span class="tooltiptext" id="reactome-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Alike KEGG patway, <a href="https://reactome.org/">Reactome</a> is a free,
open-source, curated and peer-reviewed pathway database. The
Bioconductor <em><a href="https://bioconductor.org/packages/3.15/reactome.db">reactome.db</a></em> package provides
access to reactome maps and annotations within R.</p>
</div>
<div id="molecular-signatures-database-msigdb" class="section level3" number="6.2.4">
<h3>
<span class="header-section-number">6.2.4</span> Molecular Signatures Database (MSigDB)<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('molecular-signatures-database-msigdb')" onmouseout="reset_tooltip('molecular-signatures-database-msigdb-tooltip')"><span class="tooltiptext" id="molecular-signatures-database-msigdb-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>MSigDB is a collection of annotated gene sets for use with GSEA
software. The MSigDB gene sets are divided into 9 collections:</p>
<ul>
<li>Hallmark gene sets (H) are coherently expressed signatures derived
by aggregating many MSigDB gene sets to represent well-defined
biological states or processes.</li>
<li>Positional gene sets (C1) for each human chromosome and cytogenetic band.</li>
<li>Curated gene sets (C2) from online pathway databases, publications
in PubMed, and knowledge of domain experts.</li>
<li>Regulatory target gene sets (C3) based on gene target predictions
for microRNA seed sequences and predicted transcription factor
binding sites.</li>
<li>Computational gene sets (C4) defined by mining large collections of
cancer-oriented microarray data.</li>
<li>Ontology gene sets (C5) consist of genes annotated by the same
ontology term.</li>
<li>Oncogenic signature gene (C6) sets defined directly from microarray
gene expression data from cancer gene perturbations.</li>
<li>Immunologic signature gene sets (C7) defined directly from
microarray gene expression data from immunologic studies.</li>
<li>Cell type signature gene sets (C8) curated from cluster markers
identified in single-cell sequencing studies of human tissue.</li>
</ul>
<p>The <em><a href="https://CRAN.R-project.org/package=msigdbr">msigdbr</a></em> CRAN package provides the MSigDB
gene sets in a standard R data frame with key-value pairs.</p>
</div>
<div id="input-data" class="section level3" number="6.2.5">
<h3>
<span class="header-section-number">6.2.5</span> Input data<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('input-data')" onmouseout="reset_tooltip('input-data-tooltip')"><span class="tooltiptext" id="input-data-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>To illustrate enrichment analyses, we will use the DESeq2 results
stored in the <code>res_tbl</code> variable, computed in the previous
chapter.</p>
<p>We will focus on the genes that have an adjusted p-value (those that
have been tested) and that have unique ENTREZ gene identifiers.</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="sec-gsea.html#cb343-1" aria-hidden="true" tabindex="-1"></a>res_tbl <span class="ot">&lt;-</span> res_tbl <span class="sc">%&gt;%</span></span>
<span id="cb343-2"><a href="sec-gsea.html#cb343-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID),</span>
<span id="cb343-3"><a href="sec-gsea.html#cb343-3" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span><span class="fu">is.na</span>(padj),</span>
<span id="cb343-4"><a href="sec-gsea.html#cb343-4" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span><span class="fu">duplicated</span>(ENTREZID)) <span class="sc">%&gt;%</span></span>
<span id="cb343-5"><a href="sec-gsea.html#cb343-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ENTREZID =</span> <span class="fu">as.character</span>(ENTREZID))</span>
<span id="cb343-6"><a href="sec-gsea.html#cb343-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-7"><a href="sec-gsea.html#cb343-7" aria-hidden="true" tabindex="-1"></a>res_tbl</span></code></pre></div>
<pre><code>## # A tibble: 13,719 × 9
##    ENSEMBL         baseM…¹ log2F…² lfcSE  stat    pvalue      padj gene  ENTRE…³
##    &lt;chr&gt;             &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  
##  1 ENSG00000101856   1209.   -4.67 0.178 -26.2 8.24e-152 1.37e-147 PGRM… 10857  
##  2 ENSG00000177494    277.    6.25 0.351  17.8 6.25e- 71 5.20e- 67 ZBED2 79413  
##  3 ENSG00000136159    630.    2.24 0.154  14.6 3.32e- 48 1.84e- 44 NUDT… 55270  
##  4 ENSG00000175315    220.    4.29 0.300  14.3 2.20e- 46 9.16e- 43 CST6  1474   
##  5 ENSG00000128245   2692.    2.05 0.144  14.2 5.64e- 46 1.88e- 42 YWHAH 7533   
##  6 ENSG00000113272    381.    2.33 0.171  13.6 3.45e- 42 9.55e- 39 THG1L 54974  
##  7 ENSG00000213853    506.    2.53 0.191  13.2 8.45e- 40 2.01e- 36 EMP2  2013   
##  8 ENSG00000115107    193.    3.44 0.271  12.7 7.18e- 37 1.49e- 33 STEA… 55240  
##  9 ENSG00000008513   1419.    3.00 0.240  12.5 6.39e- 36 1.18e- 32 ST3G… 6482   
## 10 ENSG00000105855   6134.    2.18 0.178  12.2 2.26e- 34 3.76e- 31 ITGB8 3696   
## # … with 13,709 more rows, and abbreviated variable names ¹​baseMean,
## #   ²​log2FoldChange, ³​ENTREZID</code></pre>
</div>
</div>
<div id="over-representation-analysis-ora" class="section level2" number="6.3">
<h2>
<span class="header-section-number">6.3</span> Over representation analysis (ORA)<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('over-representation-analysis-ora')" onmouseout="reset_tooltip('over-representation-analysis-ora-tooltip')"><span class="tooltiptext" id="over-representation-analysis-ora-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>An over representation analysis relies on the hypergeometric
distribution. The hypergeometric distribution is a discrete
probability distribution that describes the probability of <span class="math inline">\(k\)</span>
successes (random draws for which the object drawn has a specified
feature) in <span class="math inline">\(n\)</span> draws, without replacement, from a finite population
of size <span class="math inline">\(N\)</span> that contains exactly <span class="math inline">\(K\)</span> objects with that feature,
wherein each draw is either a success or a failure.</p>
<p><span class="math display">\[ P(X = k) = \frac{\binom{N}{k} \binom{N-K}{n-k}}{\binom{N}{n}} \]</span></p>
<p>where</p>
<ul>
<li>
<span class="math inline">\(N\)</span> is the population size,</li>
<li>
<span class="math inline">\(K\)</span> is the number of success states in the population,</li>
<li>
<span class="math inline">\(n\)</span> is the number of draws (i.e. quantity drawn in each trial),</li>
<li>
<span class="math inline">\(k\)</span> is the number of observed successes,</li>
<li>
<span class="math inline">\(\binom{n}{k}\)</span> is a binomial coefficient <span class="math inline">\(\frac{n!}{k! (n-k)!}\)</span>.</li>
</ul>
<p>The example used to describe the distribution is an urn contain <span class="math inline">\(N\)</span>
marbles of two colours. There are <span class="math inline">\(K\)</span> green and and <span class="math inline">\(N-K\)</span> red marbles
in the urn. Drawing a green marble is defined as success, and a red
marble failure. Using the formula above, we can compute the
probability to draw <span class="math inline">\(k\)</span> green marbles from the urn.</p>
<p>In the frame of an enrichment analysis <span class="citation">(<label for="tufte-mn-10" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-10" class="margin-toggle">Rivals et al. 2007<span class="marginnote">Rivals, I, L Personnaz, L Taing, and M C Potier. 2007. <span>“Enrichment or Depletion of a GO Category Within a Class of Genes: Which Test?”</span> <em>Bioinformatics</em> 23 (4): 401–7. <a href="https://doi.org/10.1093/bioinformatics/btl633">https://doi.org/10.1093/bioinformatics/btl633</a>.</span>)</span>, we use the
following formulation to calculate a probabiliy that we have more
green marbles than we would expect by change, i.e. there to be an over
representation of green marbles.</p>
<p><span class="math display">\[ p = 1 - \sum_{i = 0}^{k - 1} \frac{\binom{N}{k} \binom{N-K}{n-k}}{\binom{N}{n}} \]</span></p>
<p>To perform an over representation analysis, we thus need to define:</p>
<ul>
<li>among all the genes (called the universe), which ones are
differentially expressed (DE);</li>
<li>among all the genes, which ones are part of the gene set of
interest.</li>
</ul>
<p>And fill out the following table and count the number of DE genes that
are in the set of interest, the non-DE that are in the set, and the DE
and non-DE genes that are not in the set:</p>
<table>
<thead><tr class="header">
<th align="left"></th>
<th align="left">GO</th>
<th align="left">not_GO</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">DE</td>
<td align="left">n</td>
<td align="left">p</td>
</tr>
<tr class="even">
<td align="left">not_DE</td>
<td align="left">m</td>
<td align="left">q</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="sec-gsea.html#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="do">## DE and GO</span></span>
<span id="cb345-2"><a href="sec-gsea.html#cb345-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(res_tbl<span class="sc">$</span>ENTREZID[res_tbl<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.05</span>],</span>
<span id="cb345-3"><a href="sec-gsea.html#cb345-3" aria-hidden="true" tabindex="-1"></a>                      GO_0005925<span class="sc">$</span>ENTREZID))</span>
<span id="cb345-4"><a href="sec-gsea.html#cb345-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-5"><a href="sec-gsea.html#cb345-5" aria-hidden="true" tabindex="-1"></a><span class="do">## not DE and GO</span></span>
<span id="cb345-6"><a href="sec-gsea.html#cb345-6" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">intersect</span>(res_tbl<span class="sc">$</span>ENTREZID[res_tbl<span class="sc">$</span>padj <span class="sc">&gt;=</span> <span class="fl">0.05</span>],</span>
<span id="cb345-7"><a href="sec-gsea.html#cb345-7" aria-hidden="true" tabindex="-1"></a>                      GO_0005925<span class="sc">$</span>ENTREZID))</span>
<span id="cb345-8"><a href="sec-gsea.html#cb345-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-9"><a href="sec-gsea.html#cb345-9" aria-hidden="true" tabindex="-1"></a><span class="do">## DE and not GO</span></span>
<span id="cb345-10"><a href="sec-gsea.html#cb345-10" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">setdiff</span>(res_tbl<span class="sc">$</span>ENTREZID[res_tbl<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.05</span>],</span>
<span id="cb345-11"><a href="sec-gsea.html#cb345-11" aria-hidden="true" tabindex="-1"></a>                    GO_0005925<span class="sc">$</span>ENTREZID))</span>
<span id="cb345-12"><a href="sec-gsea.html#cb345-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb345-13"><a href="sec-gsea.html#cb345-13" aria-hidden="true" tabindex="-1"></a><span class="do">## not DE not not GO</span></span>
<span id="cb345-14"><a href="sec-gsea.html#cb345-14" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">setdiff</span>(res_tbl<span class="sc">$</span>ENTREZID[res_tbl<span class="sc">$</span>padj <span class="sc">&gt;=</span> <span class="fl">0.05</span>],</span>
<span id="cb345-15"><a href="sec-gsea.html#cb345-15" aria-hidden="true" tabindex="-1"></a>                    GO_0005925<span class="sc">$</span>ENTREZID))</span></code></pre></div>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="sec-gsea.html#cb346-1" aria-hidden="true" tabindex="-1"></a>cont_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(n, m, p, q), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb346-2"><a href="sec-gsea.html#cb346-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(cont_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"DE"</span>, <span class="st">"not_DE"</span>)</span>
<span id="cb346-3"><a href="sec-gsea.html#cb346-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(cont_mat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GO"</span>, <span class="st">"not_GO"</span>)</span>
<span id="cb346-4"><a href="sec-gsea.html#cb346-4" aria-hidden="true" tabindex="-1"></a>cont_mat</span></code></pre></div>
<pre><code>##         GO not_GO
## DE     159   4025
## not_DE 208   9327</code></pre>
<p>We can now apply a Fisher’s exact (or hypergeometric test) that will
test whether we can identify a statistically enrichment of DE genes in
the GO category.</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="sec-gsea.html#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fisher.test</span>(cont_mat, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span></code></pre></div>
<pre><code>## 
##  Fisher's Exact Test for Count Data
## 
## data:  cont_mat
## p-value = 9.949e-08
## alternative hypothesis: true odds ratio is greater than 1
## 95 percent confidence interval:
##  1.476287      Inf
## sample estimates:
## odds ratio 
##   1.771216</code></pre>
<p>Note that we could keep the default <code>alternative = "two.sided"</code> to
test to over or under representation.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Repeat the ORA analysis above the <a href="GO:0005813" class="uri">GO:0005813</a> term.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>This approach is straightfoward and very fast. Its major drawback
however is that we need to define a cutoff to differentiate DE from
non-DE genes. Setting this threshold might have a effect on the
results.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Try setting different DE genes and check if, in the cases above, this
has and effect on the GO terms of interest.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="gene-set-enrichment-analysis-gsea" class="section level2" number="6.4">
<h2>
<span class="header-section-number">6.4</span> Gene set enrichment analysis (GSEA)<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('gene-set-enrichment-analysis-gsea')" onmouseout="reset_tooltip('gene-set-enrichment-analysis-gsea-tooltip')"><span class="tooltiptext" id="gene-set-enrichment-analysis-gsea-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Gene set enrichment analysis refers to a broad family of tests. Here,
we will define the principles based on <span class="citation">(<label for="tufte-mn-11" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-11" class="margin-toggle">Subramanian et al. 2005<span class="marginnote">Subramanian, A, P Tamayo, V K Mootha, S Mukherjee, B L Ebert, M A Gillette, A Paulovich, et al. 2005. <span>“Gene Set Enrichment Analysis: A Knowledge-Based Approach for Interpreting Genome-Wide Expression Profiles.”</span> <em>Proc Natl Acad Sci U S A</em> 102 (43): 15545–50. <a href="https://doi.org/10.1073/pnas.0506580102">https://doi.org/10.1073/pnas.0506580102</a>.</span>)</span>, keeping in
mind that the exact implementation will differ in different tools.</p>
<p>The major advantage of GSEA approaches is that they don’t rely on
defining DE genes. The first step is to <strong>order</strong> the genes of
interest based on the statistics used; here, we will use the
p-values. This is already the case for our <code>res_tbl</code> table. We also
need to know which genes are in our set of interest.</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="sec-gsea.html#cb350-1" aria-hidden="true" tabindex="-1"></a>res_tbl<span class="sc">$</span>inGO <span class="ot">&lt;-</span> res_tbl<span class="sc">$</span>ENTREZID <span class="sc">%in%</span> GO_0005925<span class="sc">$</span>ENTREZID</span>
<span id="cb350-2"><a href="sec-gsea.html#cb350-2" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">select</span>(res_tbl, ENTREZID, padj, inGO)</span></code></pre></div>
<pre><code>## # A tibble: 13,719 × 3
##    ENTREZID      padj inGO 
##    &lt;chr&gt;        &lt;dbl&gt; &lt;lgl&gt;
##  1 10857    1.37e-147 FALSE
##  2 79413    5.20e- 67 FALSE
##  3 55270    1.84e- 44 FALSE
##  4 1474     9.16e- 43 FALSE
##  5 7533     1.88e- 42 FALSE
##  6 54974    9.55e- 39 FALSE
##  7 2013     2.01e- 36 FALSE
##  8 55240    1.49e- 33 FALSE
##  9 6482     1.18e- 32 FALSE
## 10 3696     3.76e- 31 TRUE 
## # … with 13,709 more rows</code></pre>
<p>We are now going to compute a score by traversing to ordered gene list
and count a positive score when we encounter a gene in the gene set,
and a -1 when the gene is not in the gene set. The positive score,
computed by <code>set_ratio()</code> below, is defined by <span class="math inline">\(\frac{n_{genes} - n_{genes~in~set}}{n_{genes~in~set}}\)</span> so that the sum of all genes in
the set and those not in the set becomes zero.</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="sec-gsea.html#cb352-1" aria-hidden="true" tabindex="-1"></a>set_ratio <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl) {</span>
<span id="cb352-2"><a href="sec-gsea.html#cb352-2" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">nrow</span>(tbl) <span class="sc">-</span> <span class="fu">sum</span>(tbl<span class="sc">$</span>inGO))<span class="sc">/</span><span class="fu">sum</span>(tbl<span class="sc">$</span>inGO)</span>
<span id="cb352-3"><a href="sec-gsea.html#cb352-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The cumulative sum of these scores along the ordered gene list becomes
the GSEA path which is plotted below, and the maximun score obtained
along this path is the GSEA score.</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="sec-gsea.html#cb353-1" aria-hidden="true" tabindex="-1"></a>gsea_path <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(res_tbl<span class="sc">$</span>inGO, <span class="fu">set_ratio</span>(res_tbl), <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb353-2"><a href="sec-gsea.html#cb353-2" aria-hidden="true" tabindex="-1"></a>gsea_path <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(gsea_path)</span>
<span id="cb353-3"><a href="sec-gsea.html#cb353-3" aria-hidden="true" tabindex="-1"></a>gsea_score <span class="ot">&lt;-</span> <span class="fu">max</span>(gsea_path)</span>
<span id="cb353-4"><a href="sec-gsea.html#cb353-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(gsea_path, <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb353-5"><a href="sec-gsea.html#cb353-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Ordered genes (padj)"</span>,</span>
<span id="cb353-6"><a href="sec-gsea.html#cb353-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"score"</span>,</span>
<span id="cb353-7"><a href="sec-gsea.html#cb353-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="fu">paste0</span>(<span class="st">"GSEA score: "</span>, <span class="fu">round</span>(gsea_score)))</span>
<span id="cb353-8"><a href="sec-gsea.html#cb353-8" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> gsea_score, <span class="at">col =</span> <span class="st">"steelblue"</span>, <span class="at">lty =</span> <span class="st">"dotted"</span>)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:gsea1"></span>
<p class="caption marginnote shownote">
Figure 6.3: Gene set enrichment analysis path for term <a href="GO:0005925" class="uri">GO:0005925</a>.
</p>
<img src="rnaseq_files/figure-html/gsea1-1.png" alt="Gene set enrichment analysis path for term GO:0005925." width="672">
</div>
<p>To be able to compute a statistical significance, we need to compute a
null distribution of GSEA scores, i.e. a distribution of scores
reflecting the absence of any enrichment. This is done by permuting
the samples in the original data, repeating the statistical analysis,
reorder the genes accodring to the new statistics (we used the
adjusted p-value above) and compute a new GSEA score.</p>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="sec-gsea.html#cb354-1" aria-hidden="true" tabindex="-1"></a>dds_tmp <span class="ot">&lt;-</span> dds</span>
<span id="cb354-2"><a href="sec-gsea.html#cb354-2" aria-hidden="true" tabindex="-1"></a>dds_tmp<span class="sc">$</span>Condition <span class="ot">&lt;-</span> dds_tmp<span class="sc">$</span>Condition[<span class="fu">sample</span>(<span class="fu">ncol</span>(dds_tmp))]</span>
<span id="cb354-3"><a href="sec-gsea.html#cb354-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(dds)</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 4 columns
##                Cell        Type Condition sizeFactor
##         &lt;character&gt; &lt;character&gt;  &lt;factor&gt;  &lt;numeric&gt;
## sample1       Cell1  Epithelial      mock   0.726883
## sample2       Cell1  Epithelial      mock   1.308664
## sample3       Cell1  Epithelial      mock   1.077368
## sample4       Cell1  Epithelial      KD     0.966025
## sample5       Cell1  Epithelial      KD     1.042111
## sample6       Cell1  Epithelial      KD     1.012664</code></pre>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="sec-gsea.html#cb356-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colData</span>(dds_tmp)</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 4 columns
##                Cell        Type Condition sizeFactor
##         &lt;character&gt; &lt;character&gt;  &lt;factor&gt;  &lt;numeric&gt;
## sample1       Cell1  Epithelial      mock   0.726883
## sample2       Cell1  Epithelial      KD     1.308664
## sample3       Cell1  Epithelial      KD     1.077368
## sample4       Cell1  Epithelial      mock   0.966025
## sample5       Cell1  Epithelial      mock   1.042111
## sample6       Cell1  Epithelial      KD     1.012664</code></pre>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="sec-gsea.html#cb358-1" aria-hidden="true" tabindex="-1"></a>res_tmp <span class="ot">&lt;-</span> <span class="fu">DESeq</span>(dds_tmp) <span class="sc">%&gt;%</span></span>
<span id="cb358-2"><a href="sec-gsea.html#cb358-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">results</span>(<span class="at">name =</span> <span class="st">"Condition_KD_vs_mock"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb358-3"><a href="sec-gsea.html#cb358-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb358-4"><a href="sec-gsea.html#cb358-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(ensembl_to_geneName) <span class="sc">%&gt;%</span></span>
<span id="cb358-5"><a href="sec-gsea.html#cb358-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">inGO =</span> ENTREZID <span class="sc">%in%</span> GO_0005925<span class="sc">$</span>ENTREZID) <span class="sc">%&gt;%</span></span>
<span id="cb358-6"><a href="sec-gsea.html#cb358-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID),</span>
<span id="cb358-7"><a href="sec-gsea.html#cb358-7" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span><span class="fu">is.na</span>(padj),</span>
<span id="cb358-8"><a href="sec-gsea.html#cb358-8" aria-hidden="true" tabindex="-1"></a>           <span class="sc">!</span><span class="fu">duplicated</span>(ENTREZID)) <span class="sc">%&gt;%</span></span>
<span id="cb358-9"><a href="sec-gsea.html#cb358-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(ENSEMBL, ENTREZID, padj, inGO) <span class="sc">%&gt;%</span></span>
<span id="cb358-10"><a href="sec-gsea.html#cb358-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(padj)</span>
<span id="cb358-11"><a href="sec-gsea.html#cb358-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-12"><a href="sec-gsea.html#cb358-12" aria-hidden="true" tabindex="-1"></a>res_tmp <span class="ot">&lt;-</span> res_tmp <span class="sc">%&gt;%</span></span>
<span id="cb358-13"><a href="sec-gsea.html#cb358-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">score =</span> <span class="fu">ifelse</span>(inGO, <span class="fu">set_ratio</span>(res_tmp), <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb358-14"><a href="sec-gsea.html#cb358-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">score =</span> <span class="fu">cumsum</span>(score))</span>
<span id="cb358-15"><a href="sec-gsea.html#cb358-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-16"><a href="sec-gsea.html#cb358-16" aria-hidden="true" tabindex="-1"></a>res_tmp</span></code></pre></div>
<pre><code>## # A tibble: 19,094 × 5
##    ENSEMBL          ENTREZID  padj inGO  score
##    &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt; &lt;lgl&gt; &lt;dbl&gt;
##  1 ENSG00000223972     84771 0.987 FALSE    -1
##  2 ENSG00000223972    727856 0.987 FALSE    -2
##  3 ENSG00000223972 100287102 0.987 FALSE    -3
##  4 ENSG00000223972 100287596 0.987 FALSE    -4
##  5 ENSG00000223972 102725121 0.987 FALSE    -5
##  6 ENSG00000227232    653635 0.987 FALSE    -6
##  7 ENSG00000279457 102723897 0.987 FALSE    -7
##  8 ENSG00000230021 101928626 0.987 FALSE    -8
##  9 ENSG00000237491 105378580 0.987 FALSE    -9
## 10 ENSG00000177757    400728 0.987 FALSE   -10
## # … with 19,084 more rows</code></pre>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="sec-gsea.html#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(res_tmp<span class="sc">$</span>score)</span></code></pre></div>
<pre><code>## [1] 551.802</code></pre>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="sec-gsea.html#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_tmp<span class="sc">$</span>score, <span class="at">type =</span> <span class="st">"l"</span>)</span></code></pre></div>
<p><img src="rnaseq_files/figure-html/unnamed-chunk-160-1.png" width="672"></p>
<p>This approach is very time consuming, given that the statistical tests
for all the genes need to be recomputer at each permutation. In
addition, for experiments with limited number of samples, the number
of permutations would be limited.</p>
<p>We start by defining a function that will repeat the steps above and
return a list containing the GSEA score and path.</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="sec-gsea.html#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="do">##' A function that assigns the permuted Conditions,</span></span>
<span id="cb363-2"><a href="sec-gsea.html#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="do">##' runs DESeq and a GSEA analysis</span></span>
<span id="cb363-3"><a href="sec-gsea.html#cb363-3" aria-hidden="true" tabindex="-1"></a><span class="do">##'</span></span>
<span id="cb363-4"><a href="sec-gsea.html#cb363-4" aria-hidden="true" tabindex="-1"></a><span class="do">##' @param x a DESeq object.</span></span>
<span id="cb363-5"><a href="sec-gsea.html#cb363-5" aria-hidden="true" tabindex="-1"></a><span class="do">##' @param perm `character()` of length `ncol(x)` indicating the</span></span>
<span id="cb363-6"><a href="sec-gsea.html#cb363-6" aria-hidden="true" tabindex="-1"></a><span class="do">##'     permutation to be tested.</span></span>
<span id="cb363-7"><a href="sec-gsea.html#cb363-7" aria-hidden="true" tabindex="-1"></a><span class="do">##'</span></span>
<span id="cb363-8"><a href="sec-gsea.html#cb363-8" aria-hidden="true" tabindex="-1"></a><span class="do">##' @return `numeric()` containing the GSEA path.</span></span>
<span id="cb363-9"><a href="sec-gsea.html#cb363-9" aria-hidden="true" tabindex="-1"></a>gsea_perm <span class="ot">&lt;-</span> <span class="cf">function</span>(x, perm) {</span>
<span id="cb363-10"><a href="sec-gsea.html#cb363-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Set the Condition based on the permutation</span></span>
<span id="cb363-11"><a href="sec-gsea.html#cb363-11" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>Condition[perm] <span class="ot">&lt;-</span> <span class="st">"mock"</span></span>
<span id="cb363-12"><a href="sec-gsea.html#cb363-12" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>Condition[<span class="sc">-</span>perm] <span class="ot">&lt;-</span> <span class="st">"KD"</span></span>
<span id="cb363-13"><a href="sec-gsea.html#cb363-13" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Run DESeq2, extract and annotate results</span></span>
<span id="cb363-14"><a href="sec-gsea.html#cb363-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">suppressMessages</span>(</span>
<span id="cb363-15"><a href="sec-gsea.html#cb363-15" aria-hidden="true" tabindex="-1"></a>        tbl <span class="ot">&lt;-</span> <span class="fu">DESeq</span>(x) <span class="sc">%&gt;%</span></span>
<span id="cb363-16"><a href="sec-gsea.html#cb363-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">results</span>(<span class="at">name =</span> <span class="st">"Condition_KD_vs_mock"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb363-17"><a href="sec-gsea.html#cb363-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb363-18"><a href="sec-gsea.html#cb363-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">left_join</span>(ensembl_to_geneName) <span class="sc">%&gt;%</span></span>
<span id="cb363-19"><a href="sec-gsea.html#cb363-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">inGO =</span> ENTREZID <span class="sc">%in%</span> GO_0005925<span class="sc">$</span>ENTREZID) <span class="sc">%&gt;%</span></span>
<span id="cb363-20"><a href="sec-gsea.html#cb363-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID),</span>
<span id="cb363-21"><a href="sec-gsea.html#cb363-21" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">!</span><span class="fu">is.na</span>(padj),</span>
<span id="cb363-22"><a href="sec-gsea.html#cb363-22" aria-hidden="true" tabindex="-1"></a>                   <span class="sc">!</span><span class="fu">duplicated</span>(ENTREZID)) <span class="sc">%&gt;%</span></span>
<span id="cb363-23"><a href="sec-gsea.html#cb363-23" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(ENSEMBL, ENTREZID, padj, inGO) <span class="sc">%&gt;%</span></span>
<span id="cb363-24"><a href="sec-gsea.html#cb363-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">arrange</span>(padj)</span>
<span id="cb363-25"><a href="sec-gsea.html#cb363-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb363-26"><a href="sec-gsea.html#cb363-26" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Compute GSEA results</span></span>
<span id="cb363-27"><a href="sec-gsea.html#cb363-27" aria-hidden="true" tabindex="-1"></a>    tbl <span class="ot">&lt;-</span> tbl <span class="sc">%&gt;%</span></span>
<span id="cb363-28"><a href="sec-gsea.html#cb363-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">score =</span> <span class="fu">if_else</span>(inGO, <span class="fu">set_ratio</span>(tbl), <span class="sc">-</span><span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb363-29"><a href="sec-gsea.html#cb363-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">score =</span> <span class="fu">cumsum</span>(score))</span>
<span id="cb363-30"><a href="sec-gsea.html#cb363-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(tbl<span class="sc">$</span>score)</span>
<span id="cb363-31"><a href="sec-gsea.html#cb363-31" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We will expecute this function on all unique permutations,
corresponding on the 10 first columns (including the actual design, in
the first column). Note that columns 11 to 20 are simply the opposite
of the first 10.</p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="sec-gsea.html#cb364-1" aria-hidden="true" tabindex="-1"></a>(perms <span class="ot">&lt;-</span> <span class="fu">combn</span>(<span class="dv">6</span>, <span class="dv">3</span>))</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]
## [1,]    1    1    1    1    1    1    1    1    1     1     2     2     2     2
## [2,]    2    2    2    2    3    3    3    4    4     5     3     3     3     4
## [3,]    3    4    5    6    4    5    6    5    6     6     4     5     6     5
##      [,15] [,16] [,17] [,18] [,19] [,20]
## [1,]     2     2     3     3     3     4
## [2,]     4     5     4     4     5     5
## [3,]     6     6     5     6     6     6</code></pre>
<p>We not apply our function on every permutation.</p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="sec-gsea.html#cb366-1" aria-hidden="true" tabindex="-1"></a>paths <span class="ot">&lt;-</span> <span class="fu">apply</span>(perms[, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">2</span>, <span class="cf">function</span>(p) <span class="fu">gsea_perm</span>(dds, p))</span></code></pre></div>
<p>And calculate the scores</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="sec-gsea.html#cb367-1" aria-hidden="true" tabindex="-1"></a>scores <span class="ot">&lt;-</span> <span class="fu">sapply</span>(paths, max)</span></code></pre></div>
<p>If we compare the actual score to the permutation scores, we see that
it is the largest one.</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="sec-gsea.html#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(scores))</span>
<span id="cb368-2"><a href="sec-gsea.html#cb368-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rug</span>(scores)</span>
<span id="cb368-3"><a href="sec-gsea.html#cb368-3" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> scores[<span class="dv">1</span>])</span></code></pre></div>
<p><img src="rnaseq_files/figure-html/unnamed-chunk-164-1.png" width="672"></p>
<p>An empirical p-value can be computer by dividing the number of null
scores that are greater than the real score divided by the number of
permutations (the number of null scores). In our case, given that no
null scores are greater, the nominal p-value would be 0.</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="sec-gsea.html#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(scores <span class="sc">&gt;</span> scores[<span class="dv">1</span>])<span class="sc">/</span><span class="fu">length</span>(scores)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<p>Below, we illustrate all GSEA path and confirm that the actual score
is indeed the largest one.</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb371-1"><a href="sec-gsea.html#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(paths[[<span class="dv">1</span>]], <span class="at">type =</span> <span class="st">"l"</span>,</span>
<span id="cb371-2"><a href="sec-gsea.html#cb371-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(<span class="fu">unlist</span>(paths)), <span class="fu">max</span>(scores)),</span>
<span id="cb371-3"><a href="sec-gsea.html#cb371-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">"steelblue"</span>)</span>
<span id="cb371-4"><a href="sec-gsea.html#cb371-4" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb371-5"><a href="sec-gsea.html#cb371-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(paths))</span>
<span id="cb371-6"><a href="sec-gsea.html#cb371-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines</span>(paths[[i]], <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">col =</span> <span class="st">"#00000060"</span>)</span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-166"></span>
<p class="caption marginnote shownote">
Figure 6.4: Representation of all GSEA paths: real path (blue) and random paths (dotted grey).
</p>
<img src="rnaseq_files/figure-html/unnamed-chunk-166-1.png" alt="Representation of all GSEA paths: real path (blue) and random paths (dotted grey)." width="672">
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Given that we have 10 permutations, how many null scores greater that
the actual GSEA score do we need for our results to become non
significant (assuming we set an alpha of 0.05)?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-30" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-30', 'sol-start-30')"></span>
</p>
<div id="sol-body-30" class="solution-body" style="display: none;">
<p>1 permutation score or more is enough to loose significativite, as a
single value greater than 2109 produces a p-value
of 1/10 = 0.1.</p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>There exist various approaches to the GSEA analysis, that apply
different permutation approaches to increate the number of possible
permutations and reduce the running time.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Repeat the GSEA analysis above the <a href="GO:0005813" class="uri">GO:0005813</a> term.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>While there is not need to define a list of differentially expressed
genes for the GSEA analysis, the genes need to be ordered, which can
be done in different ways and lead to different results.</p>
</div>
<div id="using-the-clusterprofiler-package" class="section level2" number="6.5">
<h2>
<span class="header-section-number">6.5</span> Using the <code>clusterProfiler</code> package<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('using-the-clusterprofiler-package')" onmouseout="reset_tooltip('using-the-clusterprofiler-package-tooltip')"><span class="tooltiptext" id="using-the-clusterprofiler-package-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>I practice, the analyses presented above are executed using any of
<a href="http://bioconductor.org/packages/release/BiocViews.html#___GeneSetEnrichment">the very
many</a>
packages that are available.
Here, we will demonstrate <em><a href="https://bioconductor.org/packages/3.15/clusterProfiler">clusterProfiler</a></em><label for="tufte-sn-15" class="margin-toggle sidenote-number">15</label><input type="checkbox" id="tufte-sn-15" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">15</span> <a href="https://yulab-smu.top/clusterProfiler-book/" class="uri">https://yulab-smu.top/clusterProfiler-book/</a></span>,
that itself relies on other packages to perform the GSEA-related computations.</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="sec-gsea.html#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"clusterProfiler"</span>)</span></code></pre></div>
<p>These dedicated packages will perform either of the two tests (or
variations thereof) to all sets, adjust the computed p-values for
multiplicity, and provide additional details and visualisations for
further exploration of the results.</p>
<div id="ora-using-go-sets" class="section level3" number="6.5.1">
<h3>
<span class="header-section-number">6.5.1</span> ORA using GO sets<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('ora-using-go-sets')" onmouseout="reset_tooltip('ora-using-go-sets-tooltip')"><span class="tooltiptext" id="ora-using-go-sets-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="sec-gsea.html#cb373-1" aria-hidden="true" tabindex="-1"></a>de_genes <span class="ot">&lt;-</span> res_tbl<span class="sc">$</span>ENTREZID[res_tbl<span class="sc">$</span>padj <span class="sc">&lt;</span> <span class="fl">0.05</span>]</span>
<span id="cb373-2"><a href="sec-gsea.html#cb373-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb373-3"><a href="sec-gsea.html#cb373-3" aria-hidden="true" tabindex="-1"></a>go_ora <span class="ot">&lt;-</span> <span class="fu">enrichGO</span>(<span class="at">gene =</span> de_genes,</span>
<span id="cb373-4"><a href="sec-gsea.html#cb373-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">universe =</span> res_tbl<span class="sc">$</span>ENTREZID,</span>
<span id="cb373-5"><a href="sec-gsea.html#cb373-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">OrgDb =</span> org.Hs.eg.db,</span>
<span id="cb373-6"><a href="sec-gsea.html#cb373-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">ont =</span> <span class="st">"CC"</span>,</span>
<span id="cb373-7"><a href="sec-gsea.html#cb373-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">readable =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb373-8"><a href="sec-gsea.html#cb373-8" aria-hidden="true" tabindex="-1"></a>    as_tibble</span>
<span id="cb373-9"><a href="sec-gsea.html#cb373-9" aria-hidden="true" tabindex="-1"></a>go_ora</span></code></pre></div>
<pre><code>## # A tibble: 19 × 9
##    ID         Description  GeneR…¹ BgRatio   pvalue p.adj…²  qvalue geneID Count
##    &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt;
##  1 GO:0022626 cytosolic r… 59/3847 91/120… 9.55e-11 6.51e-8 6.02e-8 RPL27…    59
##  2 GO:0022625 cytosolic l… 37/3847 54/120… 3.40e- 8 1.16e-5 1.07e-5 RPL27…    37
##  3 GO:0044391 ribosomal s… 83/3847 168/12… 1.46e- 6 3.30e-4 3.05e-4 DAP3/…    83
##  4 GO:0005925 focal adhes… 159/38… 367/12… 1.93e- 6 3.30e-4 3.05e-4 ITGB8…   159
##  5 GO:0030055 cell-substr… 160/38… 372/12… 3.01e- 6 4.11e-4 3.80e-4 ITGB8…   160
##  6 GO:0042788 polysomal r… 22/3847 30/120… 3.71e- 6 4.22e-4 3.90e-4 RPL38…    22
##  7 GO:0098857 membrane mi… 98/3847 210/12… 4.49e- 6 4.37e-4 4.04e-4 EMP2/…    98
##  8 GO:0045121 membrane ra… 97/3847 209/12… 6.70e- 6 5.71e-4 5.28e-4 EMP2/…    97
##  9 GO:0005840 ribosome     89/3847 195/12… 3.49e- 5 2.64e-3 2.44e-3 DAP3/…    89
## 10 GO:0022627 cytosolic s… 23/3847 37/120… 1.42e- 4 8.97e-3 8.29e-3 RPS24…    23
## 11 GO:0098984 neuron to n… 99/3847 228/12… 1.45e- 4 8.97e-3 8.29e-3 NETO2…    99
## 12 GO:0009986 cell surface 170/38… 424/12… 1.67e- 4 9.49e-3 8.78e-3 EMP2/…   170
## 13 GO:0015935 small ribos… 33/3847 63/120… 5.64e- 4 2.69e-2 2.48e-2 DAP3/…    33
## 14 GO:0015934 large ribos… 51/3847 108/12… 5.87e- 4 2.69e-2 2.48e-2 MRPL1…    51
## 15 GO:0010008 endosome me… 167/38… 425/12… 5.91e- 4 2.69e-2 2.48e-2 STEAP…   167
## 16 GO:0014069 postsynapti… 89/3847 211/12… 9.49e- 4 3.99e-2 3.69e-2 NETO2…    89
## 17 GO:0032279 asymmetric … 90/3847 214/12… 9.96e- 4 3.99e-2 3.69e-2 NETO2…    90
## 18 GO:0099572 postsynapti… 92/3847 220/12… 1.09e- 3 4.14e-2 3.83e-2 NETO2…    92
## 19 GO:0043235 receptor co… 86/3847 205/12… 1.39e- 3 5.00e-2 4.62e-2 ITGB8…    86
## # … with abbreviated variable names ¹​GeneRatio, ²​p.adjust</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Repeat the ORA analysis above using all GO namespaces. See <code>?enrichGO</code>
for details.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="gsea-using-go-sets" class="section level3" number="6.5.2">
<h3>
<span class="header-section-number">6.5.2</span> GSEA using GO sets<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('gsea-using-go-sets')" onmouseout="reset_tooltip('gsea-using-go-sets-tooltip')"><span class="tooltiptext" id="gsea-using-go-sets-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The functions that perform GSEA in <code>clusterProfiler</code> require the genes
to be ordered in decreasing order. This indicates that the p-values
can’t be used without transformations. One could also use the log2
fold-change or the (absolute value) test statistics.</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb375-1"><a href="sec-gsea.html#cb375-1" aria-hidden="true" tabindex="-1"></a>ordered_genes <span class="ot">&lt;-</span> <span class="fu">abs</span>(res_tbl<span class="sc">$</span>stat)</span>
<span id="cb375-2"><a href="sec-gsea.html#cb375-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ordered_genes) <span class="ot">&lt;-</span> res_tbl<span class="sc">$</span>ENTREZID</span>
<span id="cb375-3"><a href="sec-gsea.html#cb375-3" aria-hidden="true" tabindex="-1"></a>ordered_genes <span class="ot">&lt;-</span> <span class="fu">sort</span>(ordered_genes, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb375-4"><a href="sec-gsea.html#cb375-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb375-5"><a href="sec-gsea.html#cb375-5" aria-hidden="true" tabindex="-1"></a>go_gsea <span class="ot">&lt;-</span> <span class="fu">gseGO</span>(<span class="at">gene =</span> ordered_genes,</span>
<span id="cb375-6"><a href="sec-gsea.html#cb375-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">OrgDb =</span> org.Hs.eg.db,</span>
<span id="cb375-7"><a href="sec-gsea.html#cb375-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">scoreType =</span> <span class="st">"pos"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb375-8"><a href="sec-gsea.html#cb375-8" aria-hidden="true" tabindex="-1"></a>    as_tibble</span></code></pre></div>
<pre><code>## Warning in preparePathwaysAndStats(pathways, stats, minSize, maxSize, gseaParam, : There are ties in the preranked stats (0.62% of the list).
## The order of those tied genes will be arbitrary, which may produce unexpected results.</code></pre>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb377-1"><a href="sec-gsea.html#cb377-1" aria-hidden="true" tabindex="-1"></a>go_gsea</span></code></pre></div>
<pre><code>## # A tibble: 497 × 11
##    ID        Descr…¹ setSize enric…²   NES  pvalue p.adj…³  qvalue  rank leadi…⁴
##    &lt;chr&gt;     &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;  
##  1 GO:00308… epithe…     411   0.467  1.37 4.98e-9 2.65e-5 2.06e-5  3284 tags=3…
##  2 GO:00015… blood …     480   0.451  1.33 2.25e-8 5.97e-5 4.65e-5  4093 tags=4…
##  3 GO:00485… blood …     427   0.454  1.33 9.81e-8 1.74e-4 1.35e-4  4059 tags=4…
##  4 GO:00015… angiog…     364   0.459  1.34 1.95e-7 2.59e-4 2.02e-4  4093 tags=4…
##  5 GO:00430… positi…     377   0.458  1.34 2.48e-7 2.63e-4 2.05e-4  3702 tags=4…
##  6 GO:00430… positi…     370   0.456  1.33 3.37e-7 2.98e-4 2.32e-4  3702 tags=4…
##  7 GO:00082… negati…     465   0.445  1.31 4.30e-7 3.26e-4 2.54e-4  2478 tags=2…
##  8 GO:00602… regula…     324   0.457  1.33 7.28e-7 4.83e-4 3.77e-4  4132 tags=4…
##  9 GO:00512… positi…     379   0.453  1.32 8.56e-7 5.05e-4 3.94e-4  5085 tags=5…
## 10 GO:00423… taxis       337   0.458  1.34 1.09e-6 5.66e-4 4.41e-4  4468 tags=4…
## # … with 487 more rows, 1 more variable: core_enrichment &lt;chr&gt;, and abbreviated
## #   variable names ¹​Description, ²​enrichmentScore, ³​p.adjust, ⁴​leading_edge</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Repeat the GSEA analysis above using all GO namespaces. See
<code>?enrichGO</code> for details.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Compare and discuss the use of these different ways to order the genes
for the GSEA analysis.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Compare the GO and GSEA results. Which GO terms are shared or unique
to each approach?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-31" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-31', 'sol-start-31')"></span>
</p>
<div id="sol-body-31" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb379"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb379-1"><a href="sec-gsea.html#cb379-1" aria-hidden="true" tabindex="-1"></a>go_cc <span class="ot">&lt;-</span> <span class="fu">full_join</span>(go_ora <span class="sc">%&gt;%</span></span>
<span id="cb379-2"><a href="sec-gsea.html#cb379-2" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(p.adjust <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb379-3"><a href="sec-gsea.html#cb379-3" aria-hidden="true" tabindex="-1"></a>                   dplyr<span class="sc">::</span><span class="fu">select</span>(ID, p.adjust),</span>
<span id="cb379-4"><a href="sec-gsea.html#cb379-4" aria-hidden="true" tabindex="-1"></a>                 go_gsea <span class="sc">%&gt;%</span></span>
<span id="cb379-5"><a href="sec-gsea.html#cb379-5" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">filter</span>(p.adjust <span class="sc">&lt;</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb379-6"><a href="sec-gsea.html#cb379-6" aria-hidden="true" tabindex="-1"></a>                   dplyr<span class="sc">::</span><span class="fu">select</span>(ID, p.adjust),</span>
<span id="cb379-7"><a href="sec-gsea.html#cb379-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ID"</span> <span class="ot">=</span> <span class="st">"ID"</span>))</span>
<span id="cb379-8"><a href="sec-gsea.html#cb379-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb379-9"><a href="sec-gsea.html#cb379-9" aria-hidden="true" tabindex="-1"></a><span class="do">## shared</span></span>
<span id="cb379-10"><a href="sec-gsea.html#cb379-10" aria-hidden="true" tabindex="-1"></a><span class="fu">na.omit</span>(go_cc)</span></code></pre></div>
<pre><code>## # A tibble: 0 × 3
## # … with 3 variables: ID &lt;chr&gt;, p.adjust.x &lt;dbl&gt;, p.adjust.y &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb381"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb381-1"><a href="sec-gsea.html#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ORA only</span></span>
<span id="cb381-2"><a href="sec-gsea.html#cb381-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(go_cc, <span class="fu">is.na</span>(p.adjust.y))</span></code></pre></div>
<pre><code>## # A tibble: 12 × 3
##    ID           p.adjust.x p.adjust.y
##    &lt;chr&gt;             &lt;dbl&gt;      &lt;dbl&gt;
##  1 GO:0022626 0.0000000651         NA
##  2 GO:0022625 0.0000116            NA
##  3 GO:0044391 0.000330             NA
##  4 GO:0005925 0.000330             NA
##  5 GO:0030055 0.000411             NA
##  6 GO:0042788 0.000422             NA
##  7 GO:0098857 0.000437             NA
##  8 GO:0045121 0.000571             NA
##  9 GO:0005840 0.00264              NA
## 10 GO:0022627 0.00897              NA
## 11 GO:0098984 0.00897              NA
## 12 GO:0009986 0.00949              NA</code></pre>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb383-1"><a href="sec-gsea.html#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="do">## GSEA only</span></span>
<span id="cb383-2"><a href="sec-gsea.html#cb383-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(go_cc, <span class="fu">is.na</span>(p.adjust.x))</span></code></pre></div>
<pre><code>## # A tibble: 137 × 3
##    ID         p.adjust.x p.adjust.y
##    &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt;
##  1 GO:0030855         NA  0.0000265
##  2 GO:0001568         NA  0.0000597
##  3 GO:0048514         NA  0.000174 
##  4 GO:0001525         NA  0.000259 
##  5 GO:0043068         NA  0.000263 
##  6 GO:0043065         NA  0.000298 
##  7 GO:0008285         NA  0.000326 
##  8 GO:0060284         NA  0.000483 
##  9 GO:0051272         NA  0.000505 
## 10 GO:0042330         NA  0.000566 
## # … with 127 more rows</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="using-kegg-sets" class="section level3" number="6.5.3">
<h3>
<span class="header-section-number">6.5.3</span> Using KEGG sets<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('using-kegg-sets')" onmouseout="reset_tooltip('using-kegg-sets-tooltip')"><span class="tooltiptext" id="using-kegg-sets-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The <code>enrichKEGG()</code> and <code>gseKEGG()</code> functions can be used to perform
the ORA and GSEA analyses againt the KEGG sets.</p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Perform ORA and GSEA analysis using the KEGG set.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="using-msigdb-sets" class="section level3" number="6.5.4">
<h3>
<span class="header-section-number">6.5.4</span> Using MSigDb sets<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('using-msigdb-sets')" onmouseout="reset_tooltip('using-msigdb-sets-tooltip')"><span class="tooltiptext" id="using-msigdb-sets-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>We will use the hallmark gene set as an example here, but any set
described above can be utilised.</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb385-1"><a href="sec-gsea.html#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"msigdbr"</span>)</span>
<span id="cb385-2"><a href="sec-gsea.html#cb385-2" aria-hidden="true" tabindex="-1"></a>msig_h <span class="ot">&lt;-</span> <span class="fu">msigdbr</span>(<span class="at">species =</span> <span class="st">"Homo sapiens"</span>, <span class="at">category =</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb385-3"><a href="sec-gsea.html#cb385-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(gs_name, entrez_gene) <span class="sc">%&gt;%</span></span>
<span id="cb385-4"><a href="sec-gsea.html#cb385-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">ont =</span> gs_name, <span class="at">gene =</span> entrez_gene)</span>
<span id="cb385-5"><a href="sec-gsea.html#cb385-5" aria-hidden="true" tabindex="-1"></a>msig_h</span></code></pre></div>
<pre><code>## # A tibble: 8,209 × 2
##    ont                    gene
##    &lt;chr&gt;                 &lt;int&gt;
##  1 HALLMARK_ADIPOGENESIS    19
##  2 HALLMARK_ADIPOGENESIS 11194
##  3 HALLMARK_ADIPOGENESIS 10449
##  4 HALLMARK_ADIPOGENESIS    33
##  5 HALLMARK_ADIPOGENESIS    34
##  6 HALLMARK_ADIPOGENESIS    35
##  7 HALLMARK_ADIPOGENESIS    47
##  8 HALLMARK_ADIPOGENESIS    50
##  9 HALLMARK_ADIPOGENESIS    51
## 10 HALLMARK_ADIPOGENESIS   112
## # … with 8,199 more rows</code></pre>
<p>The <code>msig_h</code> table can now be used with the <code>enricher()</code> and <code>GSEA()</code>
functions from the <code>clusterProfiler</code> package to perform ORA and GSEA
analyses on the MSigDB hallmark gene set.</p>
<div class="sourceCode" id="cb387"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb387-1"><a href="sec-gsea.html#cb387-1" aria-hidden="true" tabindex="-1"></a>msig_ora <span class="ot">&lt;-</span> <span class="fu">enricher</span>(<span class="at">gene =</span> de_genes,</span>
<span id="cb387-2"><a href="sec-gsea.html#cb387-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">universe =</span> res_tbl<span class="sc">$</span>ENTREZID,</span>
<span id="cb387-3"><a href="sec-gsea.html#cb387-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">TERM2GENE =</span> msig_h) <span class="sc">%&gt;%</span></span>
<span id="cb387-4"><a href="sec-gsea.html#cb387-4" aria-hidden="true" tabindex="-1"></a>    as_tibble</span>
<span id="cb387-5"><a href="sec-gsea.html#cb387-5" aria-hidden="true" tabindex="-1"></a>msig_ora</span></code></pre></div>
<pre><code>## # A tibble: 3 × 9
##   ID                Descr…¹ GeneR…² BgRatio  pvalue p.adj…³  qvalue geneID Count
##   &lt;chr&gt;             &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;int&gt;
## 1 HALLMARK_HYPOXIA  HALLMA… 82/1211 164/33… 1.32e-4 0.00661 0.00584 10370…    82
## 2 HALLMARK_MYC_TAR… HALLMA… 34/1211 58/3353 3.58e-4 0.00896 0.00792 1844/…    34
## 3 HALLMARK_ALLOGRA… HALLMA… 53/1211 106/33… 2.04e-3 0.0339  0.0300  3566/…    53
## # … with abbreviated variable names ¹​Description, ²​GeneRatio, ³​p.adjust</code></pre>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb389-1"><a href="sec-gsea.html#cb389-1" aria-hidden="true" tabindex="-1"></a>msig_gsea <span class="ot">&lt;-</span> <span class="fu">GSEA</span>(ordered_genes, <span class="at">TERM2GENE =</span> msig_h, <span class="at">scoreType =</span> <span class="st">"pos"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb389-2"><a href="sec-gsea.html#cb389-2" aria-hidden="true" tabindex="-1"></a>    as_tibble</span></code></pre></div>
<pre><code>## Warning in preparePathwaysAndStats(pathways, stats, minSize, maxSize, gseaParam, : There are ties in the preranked stats (0.62% of the list).
## The order of those tied genes will be arbitrary, which may produce unexpected results.</code></pre>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb391-1"><a href="sec-gsea.html#cb391-1" aria-hidden="true" tabindex="-1"></a>msig_gsea</span></code></pre></div>
<pre><code>## # A tibble: 17 × 11
##    ID        Descr…¹ setSize enric…²   NES  pvalue p.adj…³  qvalue  rank leadi…⁴
##    &lt;chr&gt;     &lt;chr&gt;     &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;  
##  1 HALLMARK… HALLMA…     129   0.545  1.54 4.47e-7 2.24e-5 1.27e-5  2372 tags=3…
##  2 HALLMARK… HALLMA…     164   0.503  1.43 5.08e-6 1.27e-4 7.22e-5  4027 tags=5…
##  3 HALLMARK… HALLMA…      58   0.600  1.63 2.95e-5 3.68e-4 2.09e-4  3088 tags=5…
##  4 HALLMARK… HALLMA…     177   0.485  1.39 2.42e-5 3.68e-4 2.09e-4  3528 tags=4…
##  5 HALLMARK… HALLMA…     175   0.471  1.35 1.30e-4 1.30e-3 7.41e-4  4814 tags=4…
##  6 HALLMARK… HALLMA…     161   0.475  1.35 2.03e-4 1.69e-3 9.61e-4  2707 tags=3…
##  7 HALLMARK… HALLMA…     124   0.481  1.36 5.17e-4 3.70e-3 2.10e-3  3768 tags=4…
##  8 HALLMARK… HALLMA…     134   0.472  1.33 6.37e-4 3.98e-3 2.26e-3  4683 tags=4…
##  9 HALLMARK… HALLMA…     122   0.486  1.37 7.46e-4 4.15e-3 2.36e-3  4869 tags=5…
## 10 HALLMARK… HALLMA…     152   0.465  1.32 8.56e-4 4.28e-3 2.43e-3  3248 tags=3…
## 11 HALLMARK… HALLMA…     106   0.485  1.36 1.43e-3 6.48e-3 3.69e-3  4962 tags=5…
## 12 HALLMARK… HALLMA…     124   0.463  1.30 2.53e-3 1.06e-2 6.00e-3  2747 tags=3…
## 13 HALLMARK… HALLMA…     113   0.463  1.30 4.80e-3 1.84e-2 1.05e-2  5358 tags=5…
## 14 HALLMARK… HALLMA…      50   0.526  1.41 7.70e-3 2.45e-2 1.39e-2  3866 tags=4…
## 15 HALLMARK… HALLMA…     116   0.460  1.29 7.40e-3 2.45e-2 1.39e-2  2302 tags=2…
## 16 HALLMARK… HALLMA…     147   0.440  1.25 7.85e-3 2.45e-2 1.39e-2  4648 tags=4…
## 17 HALLMARK… HALLMA…     159   0.430  1.22 8.74e-3 2.57e-2 1.46e-2  5251 tags=4…
## # … with 1 more variable: core_enrichment &lt;chr&gt;, and abbreviated variable names
## #   ¹​Description, ²​enrichmentScore, ³​p.adjust, ⁴​leading_edge</code></pre>
</div>
</div>
<div id="visualisation-of-enrichment-analyses" class="section level2" number="6.6">
<h2>
<span class="header-section-number">6.6</span> Visualisation of enrichment analyses<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('visualisation-of-enrichment-analyses')" onmouseout="reset_tooltip('visualisation-of-enrichment-analyses-tooltip')"><span class="tooltiptext" id="visualisation-of-enrichment-analyses-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The <code>clusterProfiler</code> documentation provides a chapter on the
<a href="http://yulab-smu.top/clusterProfiler-book/chapter12.html">visualization of functional enrichment
results</a>.</p>
<p>Another useful visualisation, that links the enrichment results back
to the whole set of results is to highlight the genes in a particular
set of interest on the volcano plot.</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb393-1"><a href="sec-gsea.html#cb393-1" aria-hidden="true" tabindex="-1"></a>sel <span class="ot">&lt;-</span> res_tbl<span class="sc">$</span>ENTREZID <span class="sc">%in%</span> GO_0005925<span class="sc">$</span>ENTREZID</span>
<span id="cb393-2"><a href="sec-gsea.html#cb393-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(res_tbl<span class="sc">$</span>log2FoldChange, <span class="sc">-</span><span class="fu">log10</span>(res_tbl<span class="sc">$</span>padj))</span>
<span id="cb393-3"><a href="sec-gsea.html#cb393-3" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(res_tbl<span class="sc">$</span>log2FoldChange[sel],</span>
<span id="cb393-4"><a href="sec-gsea.html#cb393-4" aria-hidden="true" tabindex="-1"></a>     <span class="sc">-</span><span class="fu">log10</span>(res_tbl<span class="sc">$</span>padj)[sel],</span>
<span id="cb393-5"><a href="sec-gsea.html#cb393-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb393-6"><a href="sec-gsea.html#cb393-6" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code></pre></div>
<p><img src="rnaseq_files/figure-html/unnamed-chunk-168-1.png" width="672"></p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Extract the Entrez ids from the top hit in the <code>msig_gsea</code> results
above (available in <code>core_enrichment</code>) and visualise the results on a
volcano plot.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-32" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-32', 'sol-start-32')"></span>
</p>
<div id="sol-body-32" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb394-1"><a href="sec-gsea.html#cb394-1" aria-hidden="true" tabindex="-1"></a>entrez_ids <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(msig_gsea<span class="sc">$</span>core_enrichment[[<span class="dv">1</span>]], <span class="st">"/"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb394-2"><a href="sec-gsea.html#cb394-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-3"><a href="sec-gsea.html#cb394-3" aria-hidden="true" tabindex="-1"></a>res_tbl <span class="sc">%&gt;%</span></span>
<span id="cb394-4"><a href="sec-gsea.html#cb394-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">inGO =</span> ENTREZID <span class="sc">%in%</span> entrez_ids) <span class="sc">%&gt;%</span></span>
<span id="cb394-5"><a href="sec-gsea.html#cb394-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(inGO) <span class="sc">%&gt;%</span> <span class="do">## to plot inGO points last (on top)</span></span>
<span id="cb394-6"><a href="sec-gsea.html#cb394-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> log2FoldChange,</span>
<span id="cb394-7"><a href="sec-gsea.html#cb394-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(padj),</span>
<span id="cb394-8"><a href="sec-gsea.html#cb394-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">colour =</span> inGO)) <span class="sc">+</span></span>
<span id="cb394-9"><a href="sec-gsea.html#cb394-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="rnaseq_files/figure-html/unnamed-chunk-169-1.png" width="672"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="discussion" class="section level2" number="6.7">
<h2>
<span class="header-section-number">6.7</span> Discussion<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('discussion')" onmouseout="reset_tooltip('discussion-tooltip')"><span class="tooltiptext" id="discussion-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>Enrichment analyses are powerful techniques, as they allow to
integrate thousands of univariate results into biologically driven
sets.</p>
<p>Their interpretation isn’t however always straightforward when
different methods (ORA and GSEA) and implementations (different GSEA
permutation strategies) or user-set parameters (DE cutoffs in ORA,
ordering criteria in GSEA) provide different results.</p>

</div>
</div></body></html>

<p style="text-align: center;">
<a href="sec-rnaseq.html"><button class="btn btn-default">Previous</button></a>
</p>
<p class="build-date">Page built: 
2022-10-18
 using 
R version 4.2.1 (2022-06-23)
</p>
</div>
</div>



</body>
</html>
